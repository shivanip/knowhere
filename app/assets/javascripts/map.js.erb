//= depend_on_asset "my_marker.png"

$(function(){
  
  function initialize() {
    var myOptions = {
      zoom: 14,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    var map = new google.maps.Map(document.getElementById("map-canvas"), myOptions);

    // Try W3C Geolocation (Preferred)
    if(navigator.geolocation) {
      browserSupportFlag = true;
      navigator.geolocation.getCurrentPosition(function(position) {
        var latitude = position.coords.latitude;
        var longitude = position.coords.longitude; 
        // var image = '/images/my_marker.png';

        initialLocation = new google.maps.LatLng(latitude,longitude);
        map.setCenter(initialLocation);
        var markers = [];

        $.ajax({url: '/secrets' , dataType: 'JSON'})
        .done(function(result){
          result.forEach(function(secret){
            var secretLatLng = new google.maps.LatLng(secret.latitude,secret.longitude);
            var secretMarker = new google.maps.Marker({
              position: secretLatLng,
              map: map,
              title: secret.address
            });
            markers.push(secretMarker)
          });
        });

      
        var marker = new google.maps.Marker({
          position: initialLocation,
          map: map,
          title: 'Hello World!',
          icon: "<%= asset_path('my_marker.png') %>"
        });

        $.post('/current_locations', {latitude: latitude, longitude: longitude}, function(result){
        }); 

      }, function() {
        handleNoGeolocation(browserSupportFlag);
      });
    }

    // Browser doesn't support Geolocation
    else {
      browserSupportFlag = false;
      handleNoGeolocation(browserSupportFlag);
    }


    function handleNoGeolocation(errorFlag) {
      if (errorFlag == true) {
        alert("Geolocation service failed.");
        initialLocation = newyork;
      } else {
        alert("Your browser doesn't support geolocation. We've placed you in Siberia.");
        initialLocation = siberia;
      }
      map.setCenter(initialLocation);
    }
    
  }

  google.maps.event.addDomListener(window, 'load', initialize);

});